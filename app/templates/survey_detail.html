{% extends 'base_generic.html' %}
{% load qr_code %}
{% load crispy_forms_tags %}
{% block content %}

  <h2 class="title is-2 has-text-centered">Survey Details</h2>

  <!-- Display Django messages -->
  {% if messages %}
    <div class="messages-container">
      <ul class="messages">
        {% for message in messages %}
          <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <!-- Display survey details -->
  <div class="survey-details">
    <p class="selected-survey">Selected Survey: {{ selected_survey.name }} </p>

    <!-- Dropdown to select a survey -->
    <form method="get" class="survey-dropdown-form" onsubmit="return confirmSurveySelection()">
      <div class="field has-addons">
        <div class="control">
          <div class="select is-fullwidth">
            <select name="survey_id" class="survey-dropdown" id="surveyDropdown">
                <option value="" selected>Select a Survey</option>
                {% for survey in surveys %}
                    <option value="{{ survey.id }}">{{ survey.name }}</option>
                {% endfor %}
            </select>
          </div>
        </div>
        <div class="control">
          <button type="submit" class="button is-info view-questions-btn">View Questions</button>
        </div>
      </div>

      {% if selected_survey %}
        <a href="{% url 'survey_list' survey_id=selected_survey.id %}" class="button is-success demo-btn">Demo</a>
        <button type="button" class="button is-warning generate-qr-btn" onclick="console.log('{{ selected_survey.id }}'); generateQRCode('{{ selected_survey.id }}')">Generate QR Code</button>
        <hr>
        <div id="qrCode" class="qr-code" style="display: none;">          
          <img src="{% url 'survey_list' survey_id=selected_survey.id %}" alt="QR Code">    
        </div>
        <hr>
      {% endif %}
    </form>
  </div>
  <br><br>
  <!-- Display survey questions in a table -->
  <h3 class="title is-3 has-text-centered">Survey Questions:</h3>
  <div class="table-container">
    <table class="table is-fullwidth">
      <thead>
        <tr>
          <th>Question</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for question in questions %}
          <tr>
            <td>{{ question.question_text }}</td>
            <td>
              <div class="buttons are-small">
                <!-- Edit Form -->
                <form method="get" action="{% url 'survey_question_edit' pk=question.id %}" class="edit-form">
                  {% csrf_token %}
                  <button type="submit" class="button is-info edit-btn">Edit</button>
                </form>

                <!-- Add a small gap between buttons -->
                <div class="is-hidden-mobile" style="margin-left: 8px;"></div>

                <!-- Delete Form -->
                <form method="post" class="delete-form">
                  {% csrf_token %}
                  <input type="hidden" name="delete_question_id" value="{{ question.id }}">
                  <button type="submit" class="button is-danger delete-btn" onclick="return confirm('Are you sure you want to delete this question?')">Delete</button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Form to add a new question -->
  <form method="post" class="add-question-form">
    {% csrf_token %}
    <input type="hidden" name="survey_id" value="{{ selected_survey.id }}">
    <p class="department has-text-weight-bold">Department: {{ selected_survey.department }}</p>
    {{ form|crispy }}
    <button type="submit" class="button is-success add-question-btn">Add Question</button>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script>
    function confirmSurveySelection() {
      var surveyName = document.querySelector('.survey-dropdown').value;
      if (!surveyName) {
        alert('Please select a survey before viewing questions.');
        return false;  // Prevent form submission
      }
      return true;  // Allow form submission
    }

     // Function to set the selected value in the dropdown after form submission
     function setDropdownSelectedValue() {
      var surveyDropdown = document.getElementById('surveyDropdown');
      var selectedSurveyId = "{{ selected_survey.id }}";
      if (selectedSurveyId) {
        surveyDropdown.value = selectedSurveyId;
      }
    }

    function generateQRCode() {
    // Ensure that selected_survey is defined and has a valid id
    var surveyDropdown = document.querySelector('.survey-dropdown');
    var selectedSurveyId = surveyDropdown.value;

    if (!selectedSurveyId || selectedSurveyId === 'placeholder') {
        alert('Please select a survey before generating a QR code.');
        return false;  // Prevent further execution
    }

    // Get the URL for survey_list with the selected_survey.id
    var surveyListUrl = "http://192.168.0.37:8000/surveys/survey/list/" + selectedSurveyId + "/";
    console.log('Generated URL:', surveyListUrl);

    // Get the QR code container
    var qrCodeContainer = document.getElementById('qrCode');

    // Clear existing content in the container
    qrCodeContainer.innerHTML = '';

    // Create a new QR code instance
    var qr = new QRious({
        value: surveyListUrl,
        size: 150, // Adjust the size as needed
    });

    // Create an image element
    var qrImage = new Image();
    qrImage.src = qr.toDataURL();

    // Append the image to the container
    qrCodeContainer.appendChild(qrImage);

    // Display the QR code
    qrCodeContainer.style.display = 'block';
    console.log('QR Code generated successfully.');
    console.log('QR Element:', qr._el);
}

setDropdownSelectedValue();
  </script>
{% endblock %}
